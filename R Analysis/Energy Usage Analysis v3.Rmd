---
title: "Energy Usage Analysis"
subtitle: "An Analysis of Solar Generation Effectiveness"
author: "Student Number: 2710017"
date: "15 November 2024"
output:
  pdf_document: default
  html_document: default
links-as-notes: true
header-includes:
  \usepackage{lastpage}
  \usepackage{fancyhdr}
  \pagestyle{fancy}
  \fancyhead[L]{Energy Usage Analysis}
  \fancyhead[C]{}
  \fancyhead[R]{\thepage\ of \pageref{LastPage}}
  \fancyfoot[C]{}
bibliography: references.bib
csl: "harvard-cite-them-right.csl"
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
options(digits = 4)
```

# Introduction (20 marks)

(20 Marks)

-   Origin
-   Why is it important to me
-   Show first 5 or 6 lines of data to help understanding

## Objectives

This report looks at the use of solar energy during September 2024 in a domestic property in the southern highlands of Scotland. The property previously used oil for heating and electricity for lighting plus cooking but this was changed in order to reduce running costs and the carbon-footprint of the property. A solar array, battery and ground source heat pump were installed in order to attempt to rely solely on solar generated electricity and supplemented with import from the electricity grid only to compensate for short-falls.

The main aims of this data analysis is to answer the following questions:

1.  How effectively does the solar generation cover energy consumption?
2.  When specifically does the solar generation fall short and require grid import?
3.  Would additional battery storage capacity cover these shortfalls?
4.  Does the installation meet the expectations at the time of purchase?

## Summary of The Data

The data was collated from three original sources and combined into a single .txt file, then imported as an R dataframe.

```{r}
# Import all data from the tab-separated data file which is held in the data sub-folder
file_path <- './Data/Energy_September_2024.txt'
energy_df <- read.delim((file_path))
# Convert the string date to a valid date format
energy_df$Date <- as.Date(energy_df$Date, '%d/%m/%Y')
```

The data analysed comprises four parts, all daily data, 30 observations, for each day in September 2024:

-   Weather: Temperature and solar irradiance readings
-   Energy Use: Electricity consumption
-   Energy Source: The source of electricity: solar, battery or import from the grid
-   *Occupied*: The approximate number of hours the house is occupied each day

All data and supporting files can be found online at [Github](https://github.com/StuartG24/Home-Solar-Usage-Analysis).

### Weather

Weather data is sourced from the [Balquhidder Weather Station](https://www.blscc.org/weather) and consists of:

-   *Temp* - the mean daily temperature in $^\circ$C and is derived from 6 readings taken at 4 hourly intervals over a 24 hour period
-   *Irrdnce* - irradiance, a measure of the solar energy experienced over a specified area, units are W/m$^2$ and is used to calculate the theoretical power generated from an array of solar panels[^1]

[^1]: Wikipedia: <https://en.wikipedia.org/wiki/Solar_irradiance>

### Energy Use & Source

The distribution of power for the house is managed by a Tesla Powerwall and Controller and an iPhone app is used to monitor this, see Figure 1. All electricity data was downloaded via this app. Electricity is measured in Wh.

Electricity used and where it is sourced from:

-   *Home_Total* - total energy used by the house
-   *From_Solar* - solar power generated by an array of 36 solar panels
-   *From_PWall* - battery storage
-   *From_Grid* - the national power grid

Electricity generated by the solar panels and where it is used (the controller intelligently makes the routing decisions):

-   *Solar_Total* - total energy generated by the solar panels
-   *To_Home* - consumption by the house
-   *To_PWall* - for battery storage
-   *To_Grid* - export to the national power grid

***TO DO:** Tidy up table columns display .... look at Pandoc options etc to change layout for table and whole document? <https://pandoc.org/MANUAL.html#synopsis>*

Once the sources of data have been collated and loaded the dataset consists of 30 observations and 12 columns. The first 6 rows are shown below:

```{r, size="small"}
# Display the first 6 rows of the data
#head(energy_df)
kable(head(energy_df), caption = 'First 6 Rows of the source dataset')
```

![Tesla Powerwall](TeslaPowerwallApp.jpeg){width="40%"}

# Methods and Results - (40 marks)

The data was analysed in several groups and themes, in summary:

-   House Demand & Solar Energy Sufficiency
-   xxx
-   xxx

***WIP - Analysis, expected conclusions:***

1)  Consumption is covered by solar .. or not? how much? how much grid still needed
2)  Consumption is linked to temperature and house occupancy
3)  Solar generation is linked to irradiance .. but how much?
4)  Any other links such as temperature? .. probably not usage or occupancy though?
5)  ?? Cannot account for Â£ cost and different costs at times of day .. battery importing then for example
6)  ?? Battery timing in and out complicates the analysis?
7)  Increased battery will smooth out across days? forecast storage/impact .. but can't see the intra-day detail to better analyse
8)  Solar generation meets the forecasts at purchase .. need original data/estimates!?

## House Consumption & Solar Energy Sufficiency

### *Energy Demand*

The energy consumption of the house can be compared to the weather and its occupancy and the figure below shows this (NB: the temperature and occupancy values have been scaled to only show the relationships and so no values are displayed). At first glance, there does not appear to be a strong link between the energy demand and the outside temperature but potentially there is with occupancy.

```{r, fig.dim=c(8,5), fig.align='center', echo=FALSE}
# Base barplot of energy consumption
barplot_result <- barplot(energy_df$Home_Total, names.arg = format(energy_df$Date, "%d %b"), 
        cex.name=0.9, las=2, cex.axis=0.7, main="Daily Energy Consumption vs Weather & Occupancy", 
        ylab="Electricity Wh", ylim=c(0,25000), col = 'lightblue', space = 1.5)

# Add scaled lines for temperature and occupancy
scaled_temp <- energy_df$Temp * max(energy_df$Home_Total) / max(energy_df$Temp)
lines(barplot_result, scaled_temp, type = 'l', col = "red")
scaled_occ <- energy_df$Occupied * max(energy_df$Home_Total) / max(energy_df$Occupied)
lines(barplot_result, scaled_occ, type = 'h', col = "darkblue", lwd = 2)

legend('top', legend=c("Electricty", "Temperature", "Occupancy"),
       fill=c("lightblue", "red", "darkblue"), cex = 0.6)
```

The first bar plot below shows the total energy consumed per day by the house and a breakdown of where this energy is sourced from. It appears that the energy generated by the solar panels only meets a small proportion of the total daily consumption, on average 26%.

```{r}
average_solar_percent <- mean(c(energy_df$From_Solar / energy_df$Home_Total)) * 100
print(paste("Straight percentage:", average_solar_percent))
```

However, this is misleading as generated solar energy is often first stored in the battery for later use or exported to the gird if the battery becomes full. The second bar plot shows this more clearly. With solar energy distributed to the home, the battery or exported to the grid on average: 62%, 30% and 8% respectively.

```{r}
solar_home_percent <- mean(c(energy_df$To_Home / energy_df$Solar_Total)) * 100
solar_powerwall_percent <- mean(c(energy_df$To_Pwall / energy_df$Solar_Total)) * 100
solar_grid_percent <- mean(c(energy_df$To_Grid / energy_df$Solar_Total)) * 100
print(paste("To Home:", solar_home_percent, "To Powerwall:", solar_powerwall_percent,
            "To Grid:", solar_grid_percent))
```

A good measure of how well the solar generation meets the needs of the house's energy consumption is to simply look at how much usage is catered for without any import from the grid, and this is 80% on average.

```{r}
adjusted_solar_percent <- mean(c((energy_df$Home_Total - energy_df$From_Grid) / 
                                    energy_df$Home_Total)) * 100
print(paste("Without Grid Imported:", adjusted_solar_percent))
```

It is expected that the energy demand from the house should be related to the occupancy and also the temperature. So three linear regressions were carried out. The null hypothesis for these are that energy demand is not linked to occupancy or to temperature.

First looking at the relationship between energy demand and occupancy.

```{r, fig.dim=c(6,4), fig.align='center'}
# Plots and linear regression for energy and occupancy
regression_model <- lm(energy_df$Home_Total/1000 ~ energy_df$Occupied)
regression_summary <- summary((regression_model))
alpha <- regression_summary$coefficients["(Intercept)", "Estimate"]
beta <- regression_summary$coefficients["energy_df$Occupied", "Estimate"]
p_value <- regression_summary$coefficients["energy_df$Occupied", "Pr(>|t|)"]
adj_r_squared <- regression_summary$adj.r.squared

plot(energy_df$Home_Total/1000 ~ energy_df$Occupied, main="Daily Energy Demand vs Occupancy", 
     xlab="Occupancy Hours", ylab="Electricity kWh", las=1, xlim=c(0,25))
abline(regression_model, col="darkblue")
print(sprintf("Alpha: %.3f, Beta: %.3f", alpha, beta))
print(sprintf("p-value: %.4f, Adj R-Squared: %.3f", p_value, adj_r_squared))
```

Then looking at the relationship between energy demand and temperature (NB: same R Code so not printed to save space).

```{r, fig.dim=c(6,4), fig.align='center', echo=FALSE}
# Plots and linear regression for energy and temperature
regression_model <- lm(energy_df$Home_Total/1000 ~ energy_df$Temp)
regression_summary <- summary((regression_model))
alpha <- regression_summary$coefficients["(Intercept)", "Estimate"]
beta <- regression_summary$coefficients["energy_df$Temp", "Estimate"]
p_value <- regression_summary$coefficients["energy_df$Temp", "Pr(>|t|)"]
adj_r_squared <- regression_summary$adj.r.squared

plot(energy_df$Home_Total/1000 ~ energy_df$Temp, main="Daily Energy Demand vs Temperature", 
     xlab="Temperature", ylab="Electricity kWh", las=1, xlim=c(0,20),ylim=c(0,40))
abline(regression_model, col="darkblue")
print(sprintf("Alpha: %.3f, Beta: %.3f", alpha, beta))
print(sprintf("p-value: %.4f, Adj R-Squared: %.3f", p_value, adj_r_squared))
```

The regression analyses above do indicate a link between energy demand and occupancy and also inversely with temperature, however the adjusted r-squared values are relatively low and so the correlations are not strong. So a a multi-linear regression was completed to look at the relationship between energy demand and occupancy plus temperature (NB: A three dimensional scater plot was not attempted). The p-value for this is near zero and below the 5% critical value, it is statistically significant and we can reject the null hypothesis. From this we can infer that energy demand is linked to occupancy and temperature. In addition the high adjusted r-squared value of 0.8 suggests that there is a strong correlation between energy demand and with the combined occupancy and temperature.

***!! TO DO: For conclusions section ... temperature not massive due to good insulation and also not extremely cold etc ... but intercept does indicate as it gets colder then increases***

```{r, fig.dim=c(6,4), fig.align='center', echo=FALSE}
# Multiple linear regression for energy and temperature + occupancy
regression_model <- lm(energy_df$Home_Total/1000 ~ energy_df$Temp + energy_df$Occupied)
regression_summary <- summary((regression_model))
alpha <- regression_summary$coefficients["(Intercept)", "Estimate"]
beta0 <- regression_summary$coefficients["energy_df$Occupied", "Estimate"]
p_value0 <- regression_summary$coefficients["energy_df$Occupied", "Pr(>|t|)"]
beta1 <- regression_summary$coefficients["energy_df$Temp", "Estimate"]
p_value1 <- regression_summary$coefficients["energy_df$Temp", "Pr(>|t|)"]
adj_r_squared <- regression_summary$adj.r.squared

print(sprintf("Alpha: %.3f, Beta Occupancy: %.3f, Beta Temp: %.3f", alpha, beta0, beta1))
print(sprintf("p-value Occp: %.4f, p-value Temp: %.4f, Adj R-Squared: %.3f", p_value0, p_value1, adj_r_squared))
```

### *?? Energy Consumption ....*

```{r, fig.dim=c(8,5), fig.align='center', echo=FALSE}
# Convert to matrix for stacked bar plot
usage <- t(energy_df)[c("From_Solar", "From_Pwall", "From_Grid"), ]
barplot(usage, names.arg = format(energy_df$Date, "%d %b"), 
        cex.name=0.9, las=2, cex.axis=0.7, 
        main="Daily Energy Consumption & Sources", ylab="Electricity Wh", 
        col=3:1, ylim=c(0,25000))
legend('top', legend=c("From_Solar", "From_Pwall", "From_Grid"), title="Sources", 
       fill = 3:1, cex = 0.6)
```

```{r, fig.dim=c(8,5), fig.align='center', echo=FALSE}
# Convert to matrix for stacked bar plot
generation <- t(energy_df)[c("To_Home", "To_Pwall", "To_Grid"), ]
barplot(generation, names.arg = format(energy_df$Date, "%d %b"), 
        cex.name=0.9, las=2, cex.axis=0.7, 
        main="Daily Solar Generation & Target", ylab="Electricity Wh", 
        col=3:1, ylim=c(0,25000))
legend('top', legend=c("To-Home", "To_Pwall", "To_Grid"), title="Targets", 
       fill = 3:1, cex = 0.6)
```

### *Solar Energy Generation*


```{r}
# Installation estimates
solar_panels_area_m2 <- 72
solar_panels_max <- 9990
solar_estimated_pa_kWh <- 7920
loss_factor <- solar_estimated_pa_kWh / solar_panels_max
irradiance_assumed <- solar_estimated_pa_kWh / solar_panels_area_m2


# Ideal solar based on irradiance
ideal_solar <- energy_df$Irrdnce * solar_panels_area_m2 * 0.2
plot(ideal_solar ~ energy_df$Date, type = 'l', col='blue')
lines(energy_df$Date, energy_df$Solar_Total, type = 'l', col = "green")



month_total <- sum(energy_df$Irrdnce)
est_kwh <- (72 * month_total) / 30

assumed_irrad <- 7920 / 72


```

?? The amount of energy generated by the solar panels (kWh) is directly proportional to the level of irradiance (kWh/m$^2$) and the area of the solar panel array (m$^2$). Using this, the effectiveness of solar generation can be examined.

xx The amount of generated solar energy can be compared with the weather conditions to determine if there are any links


???? System efficiency - actual compared to ideal and see if difference ... t.test on samples

```{r, fig.dim=c(8,5), fig.align='center', echo=FALSE}
# Base barplot of solar generation
barplot_result <- barplot(energy_df$Solar_Total, names.arg = format(energy_df$Date, "%d %b"), 
        cex.name=0.9, las=2, cex.axis=0.7, main="Daily Solar Generation vs Weather", 
        ylab="Electricity Wh", ylim=c(0,17500), col = 'lightblue', space = 1.5)

# Add scaled lines for temperature and irradiance
scaled_temp <- energy_df$Temp * max(energy_df$Solar_Total) / max(energy_df$Temp)
lines(barplot_result, scaled_temp, type = 'l', col = "red")
scaled_irrdnce <- energy_df$Irrdnce * max(energy_df$Solar_Total) / max(energy_df$Irrdnce)
lines(barplot_result, scaled_irrdnce, type = 'h', col = "darkblue", lwd = 2)

legend('top', legend=c("Solar", "Temperature", "Irradiance"),
       fill=c("lightblue", "red", "darkblue"), cex = 0.6)
```

?? monthly irradiance data: <https://re.jrc.ec.europa.eu/pvg_tools/en/#MR>

### *?? Annual Forecasts & How well is as per installation expectations*

\newpage

```{r, fig.cap="First plot", out.width="90%"}
plot(energy_df$To_Home ~ energy_df$Date, type = 'l', col = 'red')
lines(energy_df$Date, energy_df$Temp, type = 'l', col = "blue")
lines(energy_df$Date, energy_df$Occupied*20, type = 'h', col = "green")
legend("topright", legend = c("Home", "Temp", "Occupied"), 
       col = c("red", "blue", "green"), lty = 1)
```

```{r, fig.cap="Second plot", out.width="90%"}
plot(energy_df$Date, energy_df$From_Solar, type = 'l', col = "red")
lines(energy_df$Date, energy_df$Irrdnce/150, type = 'l', col = "blue")
legend("topright", legend = c("Solar", "Irradiance", "xx"), 
       col = c("red", "blue", "green"), lty = 1)
```

\newpage

# Methods and Results

(40 marks)

## Method

*TO DO: Should data introduction and visualisation be here instead?*

## Results

*TO DO: Have a look back at the Bran Lab report for Spring 2018, for how to present means, SD etc etc*

# Conclusions

(20 marks)

##?? Discussion

*TO DO: Structure into two sections*

##?? Conclusion

Test citations [@Crawley2014] and as @Fraix-Burnet2016

@spiegel2012

\newpage

# References
